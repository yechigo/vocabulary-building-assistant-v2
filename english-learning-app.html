<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‹±èªå­¦ç¿’ã‚¢ãƒ—ãƒª v2 - ãƒ­ãƒƒã‚¯ç”»é¢å¯¾å¿œç‰ˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Sans', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 500px;
            width: 100%;
            padding: 30px;
        }

        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 10px;
            font-size: 24px;
        }

        .version-badge {
            text-align: center;
            color: #764ba2;
            font-size: 12px;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .setup-section, .control-section {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
            font-size: 14px;
        }

        input[type="text"], input[type="number"], input[type="password"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus, input[type="number"]:focus, input[type="password"]:focus {
            outline: none;
            border-color: #667eea;
        }

        .help-text {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        button {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .status-box {
            background: #f3f4f6;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
        }

        .current-text {
            font-size: 18px;
            color: #333;
            margin-bottom: 10px;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .progress {
            font-size: 14px;
            color: #667eea;
            text-align: center;
            font-weight: 600;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .hidden {
            display: none;
        }

        .loading {
            text-align: center;
            color: #667eea;
            font-weight: 600;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .pulse {
            animation: pulse 2s ease-in-out infinite;
        }

        .info-box {
            background: #e8f5e9;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            font-size: 13px;
            line-height: 1.6;
        }

        .warning-box {
            background: #fff3cd;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            font-size: 13px;
            line-height: 1.6;
        }

        .api-setup {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .toggle-section {
            cursor: pointer;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 5px;
            margin-bottom: 10px;
            user-select: none;
        }

        .toggle-section:hover {
            background: #e0e0e0;
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .collapsible-content.open {
            max-height: 1000px;
        }

        .cache-info {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-size: 12px;
        }

        .playback-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .playback-controls button {
            flex: 1;
            padding: 15px;
            font-size: 24px;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-secondary:disabled {
            background: #d1d5db;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ è‹±èªå­¦ç¿’ã‚¢ãƒ—ãƒª v2</h1>
        <div class="version-badge">ğŸ”“ ãƒ­ãƒƒã‚¯ç”»é¢å¯¾å¿œç‰ˆ + éŸ³å£°ã‚­ãƒ£ãƒƒã‚·ãƒ¥</div>

        <div id="mainSection" class="setup-section">
            <div class="status-box">
                <div class="current-text" id="currentText">æº–å‚™å®Œäº†</div>
                <div class="progress" id="progress">0 / 0</div>
            </div>

            <div class="playback-controls">
                <button class="btn-secondary" id="prevBtn" onclick="gotoPrevious()" disabled>â®</button>
                <button class="btn-primary" id="playPauseBtn" onclick="togglePlayPause()" disabled>â–¶</button>
                <button class="btn-secondary" id="nextBtn" onclick="gotoNext()" disabled>â­</button>
            </div>

            <div style="margin-top: 15px; text-align: center;">
                <label style="display: inline-flex; align-items: center; cursor: pointer; font-size: 14px;">
                    <input type="checkbox" id="shuffleMode" style="width: auto; margin-right: 8px;">
                    <span>ğŸ”€ ã‚·ãƒ£ãƒƒãƒ•ãƒ«ãƒ¢ãƒ¼ãƒ‰ï¼ˆãƒ©ãƒ³ãƒ€ãƒ é †ã§å†ç”Ÿï¼‰</span>
                </label>
            </div>

            <button class="btn-danger hidden" id="stopBtn" onclick="stopLearning()">åœæ­¢ã—ã¦æœ€åˆã«æˆ»ã‚‹</button>

            <button class="btn-primary" onclick="loadDataFromAppsScript()">æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿</button>

            <div class="api-setup" style="margin-top: 15px;">
                <div class="toggle-section" onclick="toggleSettings()">
                    âš™ï¸ è¨­å®šã‚’é–‹ã <span id="settingsToggleIcon">â–¼</span>
                </div>
                <div id="settingsContent" class="collapsible-content">

                    <div class="settings-grid" style="margin-top: 15px;">
                        <div>
                            <label for="jpColumn">å’Œè¨³ã®åˆ—:</label>
                            <input type="text" id="jpColumn" value="C" maxlength="2">
                        </div>
                        <div>
                            <label for="enColumn">è‹±æ–‡ã®åˆ—:</label>
                            <input type="text" id="enColumn" value="B" maxlength="2">
                        </div>
                    </div>

                    <div class="settings-grid">
                        <div>
                            <label for="waitTime">å¾…æ©Ÿæ™‚é–“ï¼ˆç§’ï¼‰:</label>
                            <input type="number" id="waitTime" value="5" min="1" max="30">
                        </div>
                        <div>
                            <label for="repeatCount">ç¹°ã‚Šè¿”ã—å›æ•°:</label>
                            <input type="number" id="repeatCount" value="1" min="1" max="10">
                        </div>
                    </div>

                    <div class="api-setup">
                        <div class="toggle-section" onclick="toggleApiSetup()">
                            âš™ï¸ Google Cloud TTS API è¨­å®š <span id="apiToggleIcon">â–¼</span>
                        </div>
                        <div id="apiSetupContent" class="collapsible-content">
                            <label for="apiKey">API ã‚­ãƒ¼:</label>
                            <input type="password" id="apiKey" placeholder="AIza...">
                            <div class="help-text">
                                â€» åˆå›ã®ã¿è¨­å®šãŒå¿…è¦ã§ã™ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã•ã‚Œã¾ã™ï¼‰<br>
                                â€» è¨­å®šæ‰‹é †ã¯ README ã‚’å‚ç…§
                            </div>
                            <button class="btn-primary" onclick="saveApiKey()" style="margin-top: 10px;">API ã‚­ãƒ¼ã‚’ä¿å­˜</button>
                        </div>
                    </div>

                    <div class="cache-info hidden" id="cacheInfo">
                        ğŸ’¾ ã‚­ãƒ£ãƒƒã‚·ãƒ¥çŠ¶æ…‹: <span id="cacheStatus">ç¢ºèªä¸­...</span>
                    </div>

                    <button class="btn-danger" onclick="clearCache()" style="margin-top: 15px; font-size: 14px;">ğŸ—‘ï¸ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢</button>
                </div>
            </div>
        </div>
    </div>

    <!-- éè¡¨ç¤ºã®Audioã‚¨ãƒ¬ãƒ¡ãƒ³ãƒˆ -->
    <audio id="audioPlayer" style="display: none;"></audio>

    <script>
        // ========================================
        // è¨­å®š
        // ========================================
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby1nEfEygjVIx0WXTjyPeL_As5aHsua9osVCbvvhuFcFHkWlZD33kWIjLuSt8AP8FJL/exec';
        const GOOGLE_TTS_API_URL = 'https://texttospeech.googleapis.com/v1/text:synthesize';
        const DB_NAME = 'EnglishLearningAppDB';
        const DB_VERSION = 1;
        const STORE_NAME = 'audioCache';

        let db = null;
        let learningData = [];
        let originalData = []; // å…ƒã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒï¼ˆã‚·ãƒ£ãƒƒãƒ•ãƒ«å‰ï¼‰
        let currentIndex = 0;
        let isPlaying = false;
        let currentRepeat = 0;
        let audioPlayer = null;
        let currentAudioBlob = null;
        let currentPlaybackState = 'stopped'; // 'playing_japanese', 'waiting', 'playing_english', 'stopped'
        let currentItem = null;
        let waitTimeoutId = null;

        // ========================================
        // IndexedDB åˆæœŸåŒ–
        // ========================================
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };

                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        db.createObjectStore(STORE_NAME, { keyPath: 'id' });
                    }
                };
            });
        }

        // ========================================
        // ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ“ä½œ
        // ========================================
        async function getCachedAudio(text, lang) {
            if (!db) await initDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const key = `${lang}:${text}`;
                const request = store.get(key);

                request.onsuccess = () => resolve(request.result?.audioData);
                request.onerror = () => reject(request.error);
            });
        }

        async function setCachedAudio(text, lang, audioData) {
            if (!db) await initDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                const key = `${lang}:${text}`;
                const request = store.put({ id: key, audioData: audioData, timestamp: Date.now() });

                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        async function clearCache() {
            if (!db) await initDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.clear();

                request.onsuccess = () => {
                    alert('ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
                    updateCacheInfo();
                    resolve();
                };
                request.onerror = () => reject(request.error);
            });
        }

        async function updateCacheInfo() {
            if (!db) return;
            const transaction = db.transaction([STORE_NAME], 'readonly');
            const store = transaction.objectStore(STORE_NAME);
            const request = store.count();

            request.onsuccess = () => {
                const count = request.result;
                document.getElementById('cacheStatus').textContent = `${count}ä»¶ã®éŸ³å£°ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä¸­`;
                document.getElementById('cacheInfo').classList.remove('hidden');
            };
        }

        // ========================================
        // Google Cloud TTS API
        // ========================================
        function saveApiKey() {
            const apiKey = document.getElementById('apiKey').value.trim();
            if (!apiKey) {
                alert('APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            localStorage.setItem('googleTtsApiKey', apiKey);
            alert('APIã‚­ãƒ¼ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
        }

        function getApiKey() {
            return localStorage.getItem('googleTtsApiKey') || '';
        }

        async function generateAudio(text, lang) {
            const apiKey = getApiKey();
            if (!apiKey) {
                throw new Error('APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
            }

            const voiceConfig = lang === 'ja-JP'
                ? { languageCode: 'ja-JP', name: 'ja-JP-Standard-A' }
                : { languageCode: 'en-US', name: 'en-US-Standard-C' };

            const requestBody = {
                input: { text: text },
                voice: voiceConfig,
                audioConfig: { audioEncoding: 'MP3', speakingRate: 0.9 }
            };

            const response = await fetch(`${GOOGLE_TTS_API_URL}?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(`TTS API Error: ${error.error?.message || 'Unknown error'}`);
            }

            const data = await response.json();
            const audioContent = data.audioContent;

            // Base64ã‚’Blobã«å¤‰æ›
            const byteCharacters = atob(audioContent);
            const byteNumbers = new Array(byteCharacters.length);
            for (let i = 0; i < byteCharacters.length; i++) {
                byteNumbers[i] = byteCharacters.charCodeAt(i);
            }
            const byteArray = new Uint8Array(byteNumbers);
            return new Blob([byteArray], { type: 'audio/mp3' });
        }

        async function getOrGenerateAudio(text, lang) {
            // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç¢ºèª
            let audioData = await getCachedAudio(text, lang);

            if (audioData) {
                console.log('Using cached audio for:', text);
                return audioData;
            }

            // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ãªã‘ã‚Œã°ç”Ÿæˆ
            console.log('Generating new audio for:', text);
            audioData = await generateAudio(text, lang);

            // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜
            await setCachedAudio(text, lang, audioData);
            await updateCacheInfo();

            return audioData;
        }

        // ========================================
        // éŸ³å£°å†ç”Ÿï¼ˆAudio API + Media Sessionï¼‰
        // ========================================
        async function playAudio(text, lang, callback) {
            try {
                const audioBlob = await getOrGenerateAudio(text, lang);
                const audioUrl = URL.createObjectURL(audioBlob);

                if (!audioPlayer) {
                    audioPlayer = document.getElementById('audioPlayer');
                }

                audioPlayer.src = audioUrl;
                audioPlayer.onended = () => {
                    URL.revokeObjectURL(audioUrl);
                    if (callback) callback();
                };
                audioPlayer.onerror = () => {
                    URL.revokeObjectURL(audioUrl);
                    console.error('Audio playback error');
                    if (callback) callback();
                };

                await audioPlayer.play();
                updateMediaSession();

            } catch (error) {
                console.error('Audio generation/playback error:', error);
                alert('éŸ³å£°ã®ç”Ÿæˆã¾ãŸã¯å†ç”Ÿã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                if (callback) callback();
            }
        }

        // Media Session API ã®æ›´æ–°
        function updateMediaSession() {
            if ('mediaSession' in navigator && currentItem) {
                const displayText = currentPlaybackState === 'playing_japanese'
                    ? currentItem.japanese
                    : currentItem.english;

                navigator.mediaSession.metadata = new MediaMetadata({
                    title: displayText,
                    artist: 'è‹±èªå­¦ç¿’ã‚¢ãƒ—ãƒª v2',
                    album: `${currentIndex + 1} / ${learningData.length} (${currentRepeat + 1}å‘¨ç›®)`
                });

                navigator.mediaSession.setActionHandler('play', handleMediaPlay);
                navigator.mediaSession.setActionHandler('pause', handleMediaPause);
                navigator.mediaSession.setActionHandler('previoustrack', handleMediaPrevious);
                navigator.mediaSession.setActionHandler('nexttrack', handleMediaNext);
            }
        }

        function handleMediaPlay() {
            if (!isPlaying) {
                resumeLearning();
            } else if (audioPlayer && audioPlayer.paused) {
                audioPlayer.play();
            }
        }

        function handleMediaPause() {
            if (audioPlayer && !audioPlayer.paused) {
                audioPlayer.pause();
            }
            pauseLearning();
        }

        function handleMediaPrevious() {
            gotoPrevious();
        }

        function handleMediaNext() {
            gotoNext();
        }

        // ========================================
        // UIåˆ¶å¾¡
        // ========================================
        function toggleSettings() {
            const content = document.getElementById('settingsContent');
            const icon = document.getElementById('settingsToggleIcon');
            content.classList.toggle('open');
            icon.textContent = content.classList.contains('open') ? 'â–²' : 'â–¼';
        }

        function toggleApiSetup() {
            const content = document.getElementById('apiSetupContent');
            const icon = document.getElementById('apiToggleIcon');
            content.classList.toggle('open');
            icon.textContent = content.classList.contains('open') ? 'â–²' : 'â–¼';
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚
        window.addEventListener('DOMContentLoaded', async () => {
            await initDB();
            await updateCacheInfo();

            // APIã‚­ãƒ¼ãŒä¿å­˜ã•ã‚Œã¦ã„ã‚Œã°è¡¨ç¤º
            const savedApiKey = getApiKey();
            if (savedApiKey) {
                document.getElementById('apiKey').value = savedApiKey;
            }

            // è¨­å®šã¯é–‰ã˜ãŸçŠ¶æ…‹ã§é–‹å§‹
            const settingsContent = document.getElementById('settingsContent');
            const settingsIcon = document.getElementById('settingsToggleIcon');
            settingsContent.classList.remove('open');
            settingsIcon.textContent = 'â–¼';
        });

        // ========================================
        // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        // ========================================
        function processCSVData(csvText, jpCol, enCol) {
            try {
                const rows = parseCSV(csvText);
                const jpIndex = jpCol.charCodeAt(0) - 65;
                const enIndex = enCol.charCodeAt(0) - 65;

                originalData = rows
                    .slice(1)
                    .filter(row => row[jpIndex] && row[enIndex])
                    .map(row => ({
                        japanese: row[jpIndex].trim(),
                        english: row[enIndex].trim()
                    }));

                if (originalData.length === 0) {
                    alert('ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚åˆ—ã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                    return;
                }

                // å…ƒã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚³ãƒ”ãƒ¼
                learningData = [...originalData];

                currentIndex = 0;
                document.getElementById('currentText').textContent = `${learningData.length}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`;
                document.getElementById('progress').textContent = `0 / ${learningData.length}`;

                // ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
                enableControls();

                // è¨­å®šã‚’é–‰ã˜ã‚‹
                const settingsContent = document.getElementById('settingsContent');
                const settingsIcon = document.getElementById('settingsToggleIcon');
                settingsContent.classList.remove('open');
                settingsIcon.textContent = 'â–¼';

            } catch (error) {
                alert('ãƒ‡ãƒ¼ã‚¿ã®å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        function enableControls() {
            document.getElementById('playPauseBtn').disabled = false;
            document.getElementById('prevBtn').disabled = false;
            document.getElementById('nextBtn').disabled = false;
        }

        function disableControls() {
            document.getElementById('playPauseBtn').disabled = true;
            document.getElementById('prevBtn').disabled = true;
            document.getElementById('nextBtn').disabled = true;
        }

        async function loadDataFromAppsScript() {
            if (!APPS_SCRIPT_URL) {
                alert('Google Apps Scriptã®URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
                return;
            }

            const jpCol = document.getElementById('jpColumn').value.toUpperCase();
            const enCol = document.getElementById('enColumn').value.toUpperCase();

            try {
                document.getElementById('currentText').innerHTML = '<div class="loading pulse">æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>';

                const response = await fetch(APPS_SCRIPT_URL);
                if (!response.ok) {
                    throw new Error('ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                }

                const csvText = await response.text();
                processCSVData(csvText, jpCol, enCol);

            } catch (error) {
                alert('ã‚¨ãƒ©ãƒ¼: ' + error.message);
                document.getElementById('currentText').textContent = 'æº–å‚™å®Œäº†';
            }
        }

        function parseCSV(text) {
            const rows = [];
            const lines = text.split('\n');

            for (let line of lines) {
                if (!line.trim()) continue;

                const row = [];
                let cell = '';
                let inQuotes = false;

                for (let i = 0; i < line.length; i++) {
                    const char = line[i];

                    if (char === '"') {
                        if (inQuotes && line[i + 1] === '"') {
                            cell += '"';
                            i++;
                        } else {
                            inQuotes = !inQuotes;
                        }
                    } else if (char === ',' && !inQuotes) {
                        row.push(cell);
                        cell = '';
                    } else {
                        cell += char;
                    }
                }
                row.push(cell);
                rows.push(row);
            }

            return rows;
        }

        // ========================================
        // å­¦ç¿’åˆ¶å¾¡
        // ========================================
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        // çµ±åˆã•ã‚ŒãŸå†ç”Ÿ/ä¸€æ™‚åœæ­¢ãƒœã‚¿ãƒ³
        function togglePlayPause() {
            if (!isPlaying) {
                // åœæ­¢çŠ¶æ…‹ã‹ã‚‰é–‹å§‹ or ä¸€æ™‚åœæ­¢ã‹ã‚‰å†é–‹
                if (!currentItem) {
                    // æœ€åˆã‹ã‚‰é–‹å§‹ï¼ˆã¾ãŸã¯stopå¾Œã®å†é–‹ï¼‰
                    startLearning();
                } else {
                    // ä¸€æ™‚åœæ­¢ã‹ã‚‰ã®å†é–‹
                    resumeLearning();
                }
            } else {
                // ä¸€æ™‚åœæ­¢
                pauseLearning();
            }
        }

        function updatePlayPauseButton() {
            const btn = document.getElementById('playPauseBtn');
            if (!isPlaying) {
                btn.textContent = 'â–¶';
            } else {
                btn.textContent = 'â¸';
            }
        }

        async function startLearning() {
            // APIã‚­ãƒ¼ãƒã‚§ãƒƒã‚¯
            if (!getApiKey()) {
                alert('Google Cloud TTS APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\nè¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            if (learningData.length === 0) return;

            // æœ€åˆã®é–‹å§‹æ™‚ï¼ˆåœæ­¢å¾Œã®å†é–‹ã§ãªã„å ´åˆï¼‰
            if (currentIndex === 0 && !currentItem) {
                // ã‚·ãƒ£ãƒƒãƒ•ãƒ«ãƒ¢ãƒ¼ãƒ‰ãªã‚‰å…ƒã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«
                if (document.getElementById('shuffleMode').checked) {
                    learningData = shuffleArray([...originalData]);
                } else {
                    // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ãªã‚‰å…ƒã®ãƒ‡ãƒ¼ã‚¿ã‚’ãã®ã¾ã¾ã‚³ãƒ”ãƒ¼
                    learningData = [...originalData];
                }
                currentRepeat = 0;
            }

            isPlaying = true;
            updatePlayPauseButton();
            document.getElementById('stopBtn').classList.remove('hidden');

            playNext();
        }

        // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½
        function gotoPrevious() {
            // ç¾åœ¨ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒ0ã‚ˆã‚Šå¤§ãã‘ã‚Œã°å‰ã«æˆ»ã‚‹
            if (currentIndex > 0) {
                currentIndex--;
                restartCurrentSentence();
            }
        }

        function gotoNext() {
            // æ¬¡ã®ã‚»ãƒ³ãƒ†ãƒ³ã‚¹ãŒã‚ã‚Œã°é€²ã‚€
            if (currentIndex < learningData.length - 1) {
                currentIndex++;
                restartCurrentSentence();
            }
        }

        function restartCurrentSentence() {
            // å†ç”Ÿä¸­ã®éŸ³å£°ã¨ã‚¿ã‚¤ãƒãƒ¼ã‚’åœæ­¢
            if (audioPlayer) {
                audioPlayer.pause();
                audioPlayer.src = '';
            }
            if (waitTimeoutId) {
                clearTimeout(waitTimeoutId);
                waitTimeoutId = null;
            }

            // è‡ªå‹•å†ç”ŸãŒæœ‰åŠ¹ãªã‚‰ç¾åœ¨ã®ã‚»ãƒ³ãƒ†ãƒ³ã‚¹ã‚’å†ç”Ÿ
            if (isPlaying) {
                playNext();
            }
        }

        function pauseLearning() {
            isPlaying = false;
            if (audioPlayer && !audioPlayer.paused) {
                audioPlayer.pause();
            }
            if (waitTimeoutId) {
                clearTimeout(waitTimeoutId);
                waitTimeoutId = null;
            }
            updatePlayPauseButton();
        }

        function resumeLearning() {
            isPlaying = true;
            updatePlayPauseButton();

            // éŸ³å£°ãŒä¸€æ™‚åœæ­¢ä¸­ãªã‚‰å†ç”Ÿ
            if (audioPlayer && audioPlayer.paused && audioPlayer.src) {
                audioPlayer.play();
            }
            // å¾…æ©Ÿä¸­ã ã£ãŸå ´åˆã¯å¾…æ©Ÿã‚’å†é–‹ã—ã¦ã‹ã‚‰æ¬¡ã¸
            else if (currentPlaybackState === 'waiting') {
                continueAfterWait();
            }
            // ãã‚Œä»¥å¤–ã¯æ¬¡ã®é …ç›®ã¸
            else {
                playNext();
            }
        }

        async function playNext() {
            if (!isPlaying || currentIndex >= learningData.length) {
                if (isPlaying) {
                    const repeatCount = parseInt(document.getElementById('repeatCount').value);
                    currentRepeat++;

                    if (currentRepeat < repeatCount) {
                        currentIndex = 0;
                        playNext();
                        return;
                    }

                    document.getElementById('currentText').textContent = 'å­¦ç¿’å®Œäº†ï¼ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼';
                    stopLearning();
                }
                return;
            }

            currentItem = learningData[currentIndex];
            const waitTime = parseInt(document.getElementById('waitTime').value) * 1000;

            document.getElementById('progress').textContent =
                `${currentIndex + 1} / ${learningData.length} (${currentRepeat + 1}å‘¨ç›®)`;

            // å’Œè¨³ã‚’è¡¨ç¤ºã—ã¦èª­ã¿ä¸Šã’
            currentPlaybackState = 'playing_japanese';
            document.getElementById('currentText').textContent = currentItem.japanese;
            await playAudio(currentItem.japanese, 'ja-JP', onJapaneseEnded);
        }

        function onJapaneseEnded() {
            if (!isPlaying) return;

            // å¾…æ©ŸçŠ¶æ…‹ã«ç§»è¡Œ
            currentPlaybackState = 'waiting';
            const waitTime = parseInt(document.getElementById('waitTime').value) * 1000;

            waitTimeoutId = setTimeout(() => {
                continueAfterWait();
            }, waitTime);
        }

        async function continueAfterWait() {
            if (!isPlaying) return;

            waitTimeoutId = null;

            // è‹±æ–‡ã‚’è¡¨ç¤ºã—ã¦èª­ã¿ä¸Šã’
            currentPlaybackState = 'playing_english';
            document.getElementById('currentText').textContent = currentItem.english;
            await playAudio(currentItem.english, 'en-US', onEnglishEnded);
        }

        function onEnglishEnded() {
            if (!isPlaying) return;

            currentIndex++;
            currentPlaybackState = 'stopped';

            // æ¬¡ã®é …ç›®ã¸ï¼ˆå°‘ã—é–“ã‚’ç©ºã‘ã‚‹ï¼‰
            setTimeout(() => {
                if (isPlaying) playNext();
            }, 1000);
        }

        function stopLearning() {
            isPlaying = false;
            currentPlaybackState = 'stopped';
            currentItem = null;

            if (waitTimeoutId) {
                clearTimeout(waitTimeoutId);
                waitTimeoutId = null;
            }

            if (audioPlayer) {
                audioPlayer.pause();
                audioPlayer.src = '';
            }

            currentRepeat = 0;
            currentIndex = 0;

            // ãƒœã‚¿ãƒ³ã‚’åˆæœŸçŠ¶æ…‹ã«æˆ»ã™
            updatePlayPauseButton();
            document.getElementById('stopBtn').classList.add('hidden');

            // é€²æ—ã‚’ãƒªã‚»ãƒƒãƒˆ
            if (learningData.length > 0) {
                document.getElementById('currentText').textContent = `${learningData.length}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`;
                document.getElementById('progress').textContent = `0 / ${learningData.length}`;
            } else {
                document.getElementById('currentText').textContent = 'æº–å‚™å®Œäº†';
                document.getElementById('progress').textContent = '0 / 0';
            }
        }
    </script>
</body>
</html>
